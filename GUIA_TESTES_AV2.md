# Guia Passo a Passo - Testes AV2 ## Pré-requisitos - Aplicação rodando em `http://localhost:8081` - Usuário criado: `admin@fmp.br` / `123456` --- ## Etapa 1: POST /auth/login - Obter JWT **Endpoint:** `POST http://localhost:8081/auth/login` **Headers:** ``` Content-Type: application/json ``` **Body (JSON):** ```json { "email": "admin@fmp.br", "senha": "123456" } ``` **Resposta esperada (200 OK):** ```json { "type": "Bearer", "token": "eyJhbGciOiJIUzI1NiJ9...", "expiresIn": 3600 } ``` **Comando cURL:** ```bash curl -X POST http://localhost:8081/auth/login \ -H 'Content-Type: application/json' \ -d '{"email":"admin@fmp.br","senha":"123456"}' ``` **No Postman:** 1. Método: `POST` 2. URL: `http://localhost:8081/auth/login` 3. Headers: `Content-Type: application/json` 4. Body (raw JSON): `{"email":"admin@fmp.br","senha":"123456"}` 5. Clique em "Send" --- ## Etapa 2: GET /aluno - Listar com Token **Endpoint:** `GET http://localhost:8081/aluno` **Headers:** ``` Authorization: Bearer <token_obtido_na_etapa_1> Content-Type: application/json ``` **Resposta esperada (200 OK):** ```json [ { "id": 1, "nome": "João Silva", "idade": 25, "cpf": "12345678900" }, { "id": 2, "nome": "Maria Santos", "idade": 22, "cpf": "98765432100" } ] ``` **Comando cURL:** ```bash TOKEN="<token_obtido_na_etapa_1>" curl -X GET http://localhost:8081/aluno \ -H "Authorization: Bearer $TOKEN" ``` **No Postman:** 1. Método: `GET` 2. URL: `http://localhost:8081/aluno` 3. Headers: `Authorization: Bearer {{jwt}}` (se importou a coleção) 4. Clique em "Send" --- ## Etapa 3: GET /aluno - Sem Token (401 Unauthorized) **Endpoint:** `GET http://localhost:8081/aluno` **Headers:** Nenhum (sem Authorization) **Resposta esperada (401 Unauthorized):** ```json { "status": 401, "error": "Unauthorized", "message": "Token de autenticação necessário", "path": "/aluno", "timestamp": "2025-11-09T16:00:00.000Z" } ``` **Comando cURL:** ```bash curl -i -X GET http://localhost:8081/aluno ``` **No Postman:** 1. Método: `GET` 2. URL: `http://localhost:8081/aluno` 3. **NÃO adicione** o header Authorization 4. Clique em "Send" 5. Verifique que retorna 401 --- ## Etapa 4: POST /aluno - Criar com Token (201 Created) **Endpoint:** `POST http://localhost:8081/aluno` **Headers:** ``` Authorization: Bearer <token> Content-Type: application/json ``` **Body (JSON):** ```json { "nome": "Novo Aluno", "idade": 20, "cpf": "99988877766" } ``` **Resposta esperada (201 Created):** ```json { "id": 3, "nome": "Novo Aluno", "idade": 20, "cpf": "99988877766" } ``` **Comando cURL:** ```bash TOKEN="<token>" curl -i -X POST http://localhost:8081/aluno \ -H "Authorization: Bearer $TOKEN" \ -H "Content-Type: application/json" \ -d '{"nome":"Novo Aluno","idade":20,"cpf":"99988877766"}' ``` **No Postman:** 1. Método: `POST` 2. URL: `http://localhost:8081/aluno` 3. Headers: `Authorization: Bearer {{jwt}}` 4. Body (raw JSON): `{"nome":"Novo Aluno","idade":20,"cpf":"99988877766"}` 5. Clique em "Send" --- ## Etapa 5: POST /aluno - CPF Duplicado (409 Conflict) **Endpoint:** `POST http://localhost:8081/aluno` **Headers:** ``` Authorization: Bearer <token> Content-Type: application/json ``` **Body (JSON):** Use o mesmo CPF da etapa 4 ```json { "nome": "Outro Aluno", "idade": 25, "cpf": "99988877766" } ``` **Resposta esperada (409 Conflict):** ```json { "status": 409, "error": "Conflict", "message": "Já existe uma pessoa com cpf", "path": "/aluno", "timestamp": "2025-11-09T16:00:00.000Z" } ``` **Comando cURL:** ```bash TOKEN="<token>" curl -i -X POST http://localhost:8081/aluno \ -H "Authorization: Bearer $TOKEN" \ -H "Content-Type: application/json" \ -d '{"nome":"Outro Aluno","idade":25,"cpf":"99988877766"}' ``` --- ## Etapa 6: GET /aluno/999 - ID Inexistente (404 Not Found) **Endpoint:** `GET http://localhost:8081/aluno/999` **Headers:** ``` Authorization: Bearer <token> ``` **Resposta esperada (404 Not Found):** ```json { "status": 404, "error": "Não encontrado", "message": "Aluno não encontrado com id: 999", "path": "/aluno/999", "timestamp": "2025-11-09T16:00:00.000Z" } ``` **Comando cURL:** ```bash TOKEN="<token>" curl -i -X GET http://localhost:8081/aluno/999 \ -H "Authorization: Bearer $TOKEN" ``` --- ## Etapa 7: POST /auth/login - Credenciais Erradas (401 Unauthorized) **Endpoint:** `POST http://localhost:8081/auth/login` **Headers:** ``` Content-Type: application/json ``` **Body (JSON):** ```json { "email": "admin@fmp.br", "senha": "senhaerrada" } ``` **Resposta esperada (401 Unauthorized):** ```json { "status": 401, "error": "Unauthorized", "message": "Credenciais inválidas", "path": "/auth/login", "timestamp": "2025-11-09T16:00:00.000Z" } ``` **Comando cURL:** ```bash curl -i -X POST http://localhost:8081/auth/login \ -H 'Content-Type: application/json' \ -d '{"email":"admin@fmp.br","senha":"senhaerrada"}' ``` --- ## Etapa 8: CORS - Frontend (localhost:3000) **Teste de CORS:** Verificar se o frontend em `http://localhost:3000` consegue acessar a API **Preflight Request (OPTIONS):** ```bash curl -i -X OPTIONS http://localhost:8081/aluno \ -H "Origin: http://localhost:3000" \ -H "Access-Control-Request-Method: GET" ``` **Headers esperados na resposta:** ``` Access-Control-Allow-Origin: http://localhost:3000 Access-Control-Allow-Methods: GET,POST,PUT,DELETE,OPTIONS Access-Control-Allow-Credentials: true Access-Control-Expose-Headers: Authorization ``` **Teste no Frontend (JavaScript):** ```javascript // Exemplo de requisição do frontend fetch('http://localhost:8081/aluno', { method: 'GET', headers: { 'Authorization': 'Bearer ' + token, 'Content-Type': 'application/json' }, credentials: 'include' }) .then(response => response.json()) .then(data => console.log(data)) .catch(error => console.error('Erro:', error)); ``` --- ## Resumo dos Status Codes Esperados | Etapa | Endpoint | Método | Status Esperado | Descrição | |-------|----------|--------|-----------------|-----------| | 1 | `/auth/login` | POST | 200 OK | Login com credenciais corretas | | 2 | `/aluno` | GET | 200 OK | Listar com token válido | | 3 | `/aluno` | GET | 401 Unauthorized | Sem token | | 4 | `/aluno` | POST | 201 Created | Criar com token válido | | 5 | `/aluno` | POST | 409 Conflict | CPF duplicado | | 6 | `/aluno/999` | GET | 404 Not Found | ID inexistente | | 7 | `/auth/login` | POST | 401 Unauthorized | Credenciais erradas | | 8 | `/aluno` | GET | 200 OK | CORS funcionando | --- ## Troubleshooting ### Erro 403 em vez de 401 - Reinicie a aplicação após as correções - Verifique se o `SecurityConfig` está configurado corretamente ### Erro CORS - Verifique se `CorsConfig` permite `http://localhost:3000` - Verifique se `SecurityConfig` usa `.cors(withDefaults())` ### Token inválido - Verifique se o token não expirou (expiresIn: 3600 = 1 hora) - Faça login novamente para obter um novo token --- ## Importar Coleção Postman 1. Abra o Postman 2. Clique em "Import" 3. Selecione o arquivo: `av2-api/Postman_Collection_AV2.json` 4. A coleção já está configurada com todos os testes 5. Execute o request "Login" primeiro para salvar o token 6. Os outros requests usarão o token automaticamente 